# bd.py
import sqlite3
from pathlib import Path

DB_PATH = Path(__file__).parent / "online_school.db"

schema = """
PRAGMA foreign_keys = ON;

CREATE TABLE IF NOT EXISTS roles(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS users(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    first_name TEXT NOT NULL,
    last_name TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL,
    role_id INTEGER NOT NULL,
    bio TEXT NOT NULL,
    created_at DATETIME,
    FOREIGN KEY(role_id) REFERENCES roles(id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE IF NOT EXISTS categories(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS courses(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    price REAL NOT NULL CHECK(price >= 0),
    level INTEGER NOT NULL CHECK(level BETWEEN 1 AND 5),
    duration_hours INTEGER NOT NULL CHECK(duration_hours > 0),
    teacher_id INTEGER NOT NULL,
    FOREIGN KEY(teacher_id) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE IF NOT EXISTS modules(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    FOREIGN KEY(course_id) REFERENCES courses(id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE IF NOT EXISTS reviews(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rating INTEGER NOT NULL CHECK(rating BETWEEN 1 AND 5),
    comment TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS enrollments(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id INTEGER NOT NULL,
    course_id INTEGER NOT NULL,
    enrolled_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    payments INTEGER NOT NULL,
    certificates TEXT NOT NULL, 
    reviews_id INTEGER NOT NULL,
    UNIQUE(student_id, course_id, reviews_id),
    FOREIGN KEY(student_id) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY(course_id) REFERENCES courses(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY(reviews_id) REFERENCES reviews(id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE IF NOT EXISTS course_categories(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id INTEGER NOT NULL,
    category_id INTEGER NOT NULL,
    UNIQUE(course_id, category_id),
    FOREIGN KEY(course_id) REFERENCES courses(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY(category_id) REFERENCES categories(id) ON DELETE CASCADE ON UPDATE CASCADE
);
"""

seed = [
    ("INSERT INTO roles(name, description) VALUES(?,?)",
     [("Студент", "Учащийся, который проходит курсы"),
      ("Преподаватель", "Преподаватель, который создает и ведет курсы"),
      ("Администратор", "Администратор системы")]),

    ("INSERT INTO users(first_name, last_name, email, password, role_id, bio, created_at) VALUES(?,?,?,?,?,?,?)",
     [("Александр", "Васильев", "admin1@school.ru", "admin111", 3, "Главный администратор онлайн-школы",
       "2024-01-01 10:00:00"),
      ("Екатерина", "Морозова", "admin2@school.ru", "admin222", 3, "Администратор учебного процесса",
       "2024-01-02 11:00:00"),
      ("Дмитрий", "Кузнецов", "admin3@school.ru", "admin333", 3, "Технический администратор", "2024-01-03 12:00:00")]),

    # 3 преподавателя
    ("INSERT INTO users(first_name, last_name, email, password, role_id, bio, created_at) VALUES(?,?,?,?,?,?,?)",
     [("Иван", "Петров", "ivan.petrov@school.ru", "teach111", 2,
       "Опытный преподаватель программирования с 10-летним стажем. Специализация: Python, алгоритмы, ООП",
       "2024-01-04 09:00:00"),
      ("Мария", "Сидорова", "maria.sidorova@school.ru", "teach222", 2,
       "Senior веб-разработчик. Преподаю Django, Flask, React. Люблю делиться практическим опытом",
       "2024-01-05 10:00:00"),
      ("Сергей", "Иванов", "sergey.ivanov@school.ru", "teach333", 2,
       "Data Scientist в крупной IT компании. Преподаю машинное обучение и анализ данных", "2024-01-06 11:00:00")]),

    # 10 студентов
    ("INSERT INTO users(first_name, last_name, email, password, role_id, bio, created_at) VALUES(?,?,?,?,?,?,?)",
     [("Анна", "Смирнова", "anna.smirnova@student.ru", "student111", 1,
       "Начинающий разработчик. Хочу освоить Python и найти работу мечты", "2024-02-01 08:00:00"),
      ("Михаил", "Попов", "mikhail.popov@student.ru", "student222", 1,
       "Студент технического вуза. Интересуюсь backend-разработкой", "2024-02-02 09:00:00"),
      ("Ольга", "Васильева", "olga.vasileva@student.ru", "student333", 1,
       "Переучиваюсь на программиста. В восторге от возможностей Python", "2024-02-03 10:00:00"),
      ("Алексей", "Соколов", "aleksey.sokolov@student.ru", "student444", 1,
       "Фронтенд разработчик, хочу стать фуллстек", "2024-02-04 11:00:00"),
      ("Елена", "Новикова", "elena.novikova@student.ru", "student555", 1,
       "Маркетолог, изучаю программирование для автоматизации задач", "2024-02-05 12:00:00"),
      ("Артем", "Федоров", "artem.fedorov@student.ru", "student666", 1,
       "Школьник, увлекаюсь программированием. Python - мой первый язык", "2024-02-06 13:00:00"),
      ("Наталья", "Морозова", "natalya.morozova@student.ru", "student777", 1,
       "Биолог, изучаю Python для анализа научных данных", "2024-02-07 14:00:00"),
      ("Павел", "Волков", "pavel.volkov@student.ru", "student888", 1,
       "Начинающий data scientist. Хочу углубить знания в ML", "2024-02-08 15:00:00"),
      ("Юлия", "Алексеева", "yulia.alekseeva@student.ru", "student999", 1,
       "Дизайнер, изучаю веб-разработку для создания собственных проектов", "2024-02-09 16:00:00"),
      ("Роман", "Лебедев", "roman.lebedev@student.ru", "student123", 1,
       "Системный администратор, хочу освоить программирование", "2024-02-10 17:00:00")]),

    ("INSERT INTO categories(name, description) VALUES(?,?)",
     [("Программирование", "Курсы по программированию и разработке ПО"),
      ("Веб-разработка", "Курсы по созданию веб-сайтов и приложений"),
      ("Data Science", "Курсы по анализу данных и машинному обучению"),
      ("Базы данных", "Курсы по работе с базами данных и SQL"),
      ("Мобильная разработка", "Курсы по созданию мобильных приложений")]),

    ("INSERT INTO courses(title, description, price, level, duration_hours, teacher_id) VALUES(?,?,?,?,?,?)",
     [("Python для начинающих",
       "Полный курс по основам Python: синтаксис, структуры данных, ООП. Идеально для старта в программировании.",
       5000.0, 1, 40, 4),
      ("Веб-разработка на Django", "Создание полноценных веб-приложений на Django. От основ до deployment.", 8000.0, 2,
       60, 5),
      ("Машинное обучение на Python",
       "Введение в ML: от предобработки данных до построения моделей. Scikit-learn, pandas, numpy.", 12000.0, 3, 80, 6),
      ("Продвинутый Python",
       "Глубокое погружение в Python: декораторы, генераторы, метаклассы, асинхронное программирование.", 7000.0, 3, 50,
       4),
      ("Flask: от простого к сложному",
       "Создание веб-приложений на Flask. REST API, аутентификация, работа с базами данных.", 6000.0, 2, 45, 5),
      ("SQL и базы данных", "Полный курс по работе с базами данных: от простых запросов до оптимизации.", 4500.0, 1, 35,
       4)]),

    ("INSERT INTO course_categories(course_id, category_id) VALUES(?,?)",
     [(1, 1), (2, 1), (2, 2), (3, 1), (3, 3), (4, 1), (5, 1), (5, 2), (6, 1), (6, 4)]),

    ("INSERT INTO modules(course_id, title, description) VALUES(?,?,?)",
     [(1, "Основы Python", "Синтаксис, переменные, типы данных, основные операторы"),
      (1, "Функции и модули", "Создание функций, работа с модулями, область видимости"),
      (1, "ООП в Python", "Классы, объекты, наследование, полиморфизм"),
      (2, "Основы Django", "Модели, представления, шаблоны - основа фреймворка"),
      (2, "Django ORM", "Работа с базами данных через ORM, миграции"),
      (2, "Django REST Framework", "Создание API для веб-приложений"),
      (3, "Введение в Data Science", "Основные понятия и инструменты анализа данных"),
      (3, "Предобработка данных", "Очистка и подготовка данных для анализа"),
      (3, "Машинное обучение", "Построение и оценка ML моделей")]),

    ("INSERT INTO reviews(rating, comment) VALUES(?,?)",
     [(5, "Отличный курс для начинающих! Все объясняется доступно и понятно"),
      (4, "Хорошая структура курса, но хотелось бы больше практических заданий"),
      (5, "Мария - прекрасный преподаватель! Много практики и реальных примеров"),
      (5, "Сергей отлично объясняет сложные темы машинного обучения"),
      (4, "Полезный курс, помог систематизировать знания по SQL"),
      (5, "Отличный преподаватель, понятно объясняет"),
      (4, "Хороший курс, но сложновато для новичков"),
      (5, "Супер! Много практических примеров"),
      (4, "Понравилась структура курса"),
      (5, "Лучший курс по Python!"),
      (4, "Информативно, но мало практики"),
      (5, "Прекрасный курс для начинающих"),
      (4, "Хорошо, но можно добавить больше материалов"),
      (5, "Отлично структурированная информация"),
      (3, "Нормально, но ожидал большего"),
      (5, "Преподаватель - профессионал!"),
      (4, "Полезный контент")]),

("INSERT INTO enrollments(student_id, course_id, payments, certificates, reviews_id) VALUES(?,?,?,?,?)",
     [(7, 1, 1, "Сертификат Python для начинающих", 1),   # Анна Смирнова
      (7, 2, 1, "Сертификат Веб-разработка на Django", 2),
      (8, 1, 1, "Сертификат Python для начинающих", 3),   # Михаил Попов
      (8, 6, 1, "Сертификат SQL и базы данных", 4),
      (9, 1, 1, "Сертификат Python для начинающих", 5),   # Ольга Васильева
      (9, 3, 1, "Сертификат Машинное обучение на Python", 6),
      (10, 2, 1, "Сертификат Веб-разработка на Django", 7),  # Алексей Соколов
      (10, 5, 1, "Сертификат Flask: от простого к сложному", 8),
      (11, 1, 1, "Сертификат Python для начинающих", 9),  # Елена Новикова
      (11, 6, 1, "Сертификат SQL и базы данных", 10),
      (12, 1, 1, "Сертификат Python для начинающих", 11), # Артем Федоров
      (13, 3, 1, "Сертификат Машинное обучение на Python", 12), # Наталья Морозова
      (13, 6, 1, "Сертификат SQL и базы данных", 13),
      (14, 3, 1, "Сертификат Машинное обучение на Python", 14), # Павел Волков
      (14, 4, 1, "Сертификат Продвинутый Python", 15),
      (15, 2, 1, "Сертификат Веб-разработка на Django", 16), # Юлия Алексеева
      (15, 5, 1, "Сертификат Flask: от простого к сложному", 17),
      (16, 1, 1, "Сертификат Python для начинающих", 5),  # Роман Лебедев (повторяем отзыв 5)
      (16, 3, 1, "Сертификат Машинное обучение на Python", 6)])
]


def initialize_database():
    """Инициализация базы данных"""
    with sqlite3.connect(DB_PATH) as conn:
        # Включаем поддержку внешних ключей
        conn.execute("PRAGMA foreign_keys = ON")

        # Создаем таблицы
        conn.executescript(schema)

        # Проверяем, пуста ли база данных
        cursor = conn.execute("SELECT COUNT(*) FROM roles")
        if cursor.fetchone()[0] == 0:
            # Заполняем тестовыми данными
            for sql, rows in seed:
                conn.executemany(sql, rows)

        conn.commit()

    print(f"База данных онлайн-школы создана: {DB_PATH}")


def get_db_connection():
    """Получить соединение с базой данных"""
    conn = sqlite3.connect(DB_PATH)
    conn.execute("PRAGMA foreign_keys = ON")
    conn.row_factory = sqlite3.Row  # Для доступа к колонкам по имени
    return conn


if __name__ == "__main__":
    initialize_database()
